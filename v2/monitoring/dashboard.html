<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Video V2 - Dashboard de Monitoramento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .unit {
            font-size: 0.9em;
            opacity: 0.7;
        }

        .camera-section {
            margin-bottom: 30px;
        }

        .camera-section h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .camera-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .camera-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .camera-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-running {
            background: #4caf50;
            color: white;
        }

        .status-stopped {
            background: #f44336;
            color: white;
        }

        .status-warning {
            background: #ff9800;
            color: white;
        }

        .camera-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .refresh-info {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Edge Video V2</h1>
            <p>Dashboard de Monitoramento em Tempo Real</p>
        </div>

        <div id="error-container"></div>

        <div class="stats-grid" id="global-stats">
            <div class="stat-card">
                <h3>Total de Frames Publicados</h3>
                <div class="value loading" id="total-published">-</div>
                <div class="unit">frames</div>
            </div>

            <div class="stat-card">
                <h3>Taxa de Confirma√ß√£o</h3>
                <div class="value loading" id="ack-rate">-</div>
                <div class="unit">% ACK</div>
            </div>

            <div class="stat-card">
                <h3>Uso de RAM</h3>
                <div class="value loading" id="ram-usage">-</div>
                <div class="unit">MB</div>
            </div>

            <div class="stat-card">
                <h3>Goroutines Ativas</h3>
                <div class="value loading" id="goroutines">-</div>
                <div class="unit">threads</div>
            </div>

            <div class="stat-card">
                <h3>Tempo de Execu√ß√£o</h3>
                <div class="value loading" id="uptime">-</div>
                <div class="unit">segundos</div>
            </div>

            <div class="stat-card">
                <h3>Circuit Breakers OPEN</h3>
                <div class="value loading" id="cb-open">-</div>
                <div class="unit">c√¢meras</div>
            </div>
        </div>

        <div class="camera-section">
            <h2>üé• Status das C√¢meras</h2>
            <div class="cameras-grid" id="cameras-grid"></div>
        </div>

        <div class="refresh-info">
            Atualiza√ß√£o autom√°tica a cada 5 segundos | √öltima atualiza√ß√£o: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        const METRICS_URL = 'http://localhost:2112/metrics';
        const CAMERAS = ['cam1', 'cam2', 'cam3', 'cam4', 'cam5', 'cam6'];

        function parsePrometheusMetrics(text) {
            const metrics = {};
            const lines = text.split('\n');

            for (const line of lines) {
                if (line.startsWith('#') || line.trim() === '') continue;

                const match = line.match(/^([a-z_]+)\{([^}]*)\}\s+(.+)$/);
                if (match) {
                    const [, metricName, labels, value] = match;
                    const labelPairs = {};

                    labels.split(',').forEach(pair => {
                        const [key, val] = pair.split('=');
                        if (key && val) {
                            labelPairs[key.trim()] = val.replace(/"/g, '').trim();
                        }
                    });

                    if (!metrics[metricName]) {
                        metrics[metricName] = [];
                    }

                    metrics[metricName].push({
                        labels: labelPairs,
                        value: parseFloat(value)
                    });
                } else {
                    const simpleMatch = line.match(/^([a-z_]+)\s+(.+)$/);
                    if (simpleMatch) {
                        const [, metricName, value] = simpleMatch;
                        metrics[metricName] = parseFloat(value);
                    }
                }
            }

            return metrics;
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        function updateGlobalStats(metrics) {
            // Total de frames publicados
            const totalPublished = CAMERAS.reduce((sum, cam) => {
                const metric = metrics.edge_video_frames_published_total?.find(m => m.labels.camera_id === cam);
                return sum + (metric?.value || 0);
            }, 0);
            document.getElementById('total-published').textContent = totalPublished.toLocaleString();

            // Taxa de ACK
            const acks = metrics.edge_video_publisher_confirms_ack_total || 0;
            const nacks = metrics.edge_video_publisher_confirms_nack_total || 0;
            const ackRate = acks + nacks > 0 ? ((acks / (acks + nacks)) * 100).toFixed(1) : 100;
            document.getElementById('ack-rate').textContent = ackRate;

            // RAM
            const ram = metrics.edge_video_system_ram_mb || 0;
            document.getElementById('ram-usage').textContent = ram.toFixed(1);

            // Goroutines
            const goroutines = metrics.edge_video_system_goroutines || 0;
            document.getElementById('goroutines').textContent = goroutines;

            // Uptime
            const uptime = metrics.edge_video_uptime_seconds || 0;
            document.getElementById('uptime').textContent = formatUptime(uptime);

            // Circuit Breakers OPEN
            const cbOpen = CAMERAS.filter(cam => {
                const metric = metrics.edge_video_circuit_breaker_state?.find(m => m.labels.camera_id === cam);
                return metric?.value === 1;
            }).length;
            document.getElementById('cb-open').textContent = cbOpen;

            // Remove loading animation
            document.querySelectorAll('.loading').forEach(el => el.classList.remove('loading'));
        }

        function getCameraStatus(metrics, cameraId) {
            const cbState = metrics.edge_video_circuit_breaker_state?.find(m => m.labels.camera_id === cameraId);
            const framesReceived = metrics.edge_video_frames_received_total?.find(m => m.labels.camera_id === cameraId);

            if (cbState?.value === 1) return 'warning';
            if (framesReceived?.value > 0) return 'running';
            return 'stopped';
        }

        function updateCamerasGrid(metrics) {
            const grid = document.getElementById('cameras-grid');
            grid.innerHTML = '';

            CAMERAS.forEach(cameraId => {
                const framesReceived = metrics.edge_video_frames_received_total?.find(m => m.labels.camera_id === cameraId)?.value || 0;
                const framesPublished = metrics.edge_video_frames_published_total?.find(m => m.labels.camera_id === cameraId)?.value || 0;
                const framesDropped = metrics.edge_video_frames_dropped_total?.find(m => m.labels.camera_id === cameraId)?.value || 0;
                const fps = metrics.edge_video_camera_fps?.find(m => m.labels.camera_id === cameraId)?.value || 0;
                const latency = metrics.edge_video_publish_latency_ms?.find(m => m.labels.camera_id === cameraId)?.value || 0;
                const frameSize = metrics.edge_video_frame_size_bytes?.find(m => m.labels.camera_id === cameraId)?.value || 0;

                const status = getCameraStatus(metrics, cameraId);
                const statusClass = status === 'running' ? 'status-running' : status === 'warning' ? 'status-warning' : 'status-stopped';
                const statusText = status === 'running' ? 'ONLINE' : status === 'warning' ? 'CB OPEN' : 'OFFLINE';

                const card = document.createElement('div');
                card.className = 'camera-card';
                card.innerHTML = `
                    <div class="camera-header">
                        <div class="camera-name">${cameraId.toUpperCase()}</div>
                        <div class="camera-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="camera-metrics">
                        <div class="metric">
                            <div class="metric-label">Frames Recebidos</div>
                            <div class="metric-value">${framesReceived.toLocaleString()}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Frames Publicados</div>
                            <div class="metric-value">${framesPublished.toLocaleString()}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Frames Descartados</div>
                            <div class="metric-value">${framesDropped.toLocaleString()}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">FPS Real</div>
                            <div class="metric-value">${fps.toFixed(1)}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Lat√™ncia Publica√ß√£o</div>
                            <div class="metric-value">${latency.toFixed(2)} ms</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Tamanho do Frame</div>
                            <div class="metric-value">${(frameSize / 1024).toFixed(0)} KB</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function fetchMetrics() {
            try {
                const response = await fetch(METRICS_URL);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const text = await response.text();
                const metrics = parsePrometheusMetrics(text);

                updateGlobalStats(metrics);
                updateCamerasGrid(metrics);

                document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pt-BR');
                document.getElementById('error-container').innerHTML = '';

            } catch (error) {
                console.error('Erro ao buscar m√©tricas:', error);
                document.getElementById('error-container').innerHTML = `
                    <div class="error">
                        ‚ùå Erro ao conectar com o servidor de m√©tricas: ${error.message}<br>
                        Verifique se o Edge Video V2 est√° rodando em http://localhost:2112/metrics
                    </div>
                `;
            }
        }

        // Fetch inicial
        fetchMetrics();

        // Atualiza√ß√£o autom√°tica a cada 5 segundos
        setInterval(fetchMetrics, 5000);
    </script>
</body>
</html>
